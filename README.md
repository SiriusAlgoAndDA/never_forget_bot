# Never Forget Bot

Telegram-бот для создания напоминаний и управления событиями, который поможет вам не забывать о важных задачах и встречах.

## Описание проекта

Never Forget Bot - это интеллектуальный бот-напоминание для Telegram, который:

- **Понимает естественный язык** - вы можете просто написать "Напомни завтра в 15:00 о встрече с клиентом" и бот создаст напоминание
- **Поддерживает голосовые сообщения** - записывайте голосовые напоминания, бот распознает речь и создаст событие
- **Использует искусственный интеллект** - интеграция с Yandex GPT для понимания и парсинга сообщений
- **Управляет временными задачами** - использует Temporal для надежного планирования уведомлений
- **Поддерживает различные типы событий** - обычные, с подготовкой, повторяющиеся
- **Интерактивное управление** - кнопки для отложения, завершения и управления событиями

## Архитектура

### Основные компоненты

1. **Telegram Bot** (aiogram) - основной интерфейс взаимодействия с пользователями
2. **База данных** (PostgreSQL + SQLAlchemy) - хранение пользователей, событий и уведомлений
3. **Temporal** - надежная система планирования и выполнения задач
4. **Yandex GPT** - обработка естественного языка для создания событий
5. **Yandex SpeechKit** - распознавание речи для голосовых сообщений

### Структура проекта

```
bot/
├── __main__.py              # Точка входа приложения
├── creator.py               # Создание и настройка бота
├── bot_helper/              # Вспомогательные функции бота
│   └── send/               # Отправка сообщений и уведомлений
├── config/                  # Конфигурация приложения
├── database/               # Модели данных и миграции
│   ├── models/             # SQLAlchemy модели
│   └── migrator/           # Alembic миграции
├── handlers/               # Обработчики команд и сообщений
├── middlewares/            # Middleware для обработки запросов
├── temporal/               # Temporal workflows
├── utils/                  # Утилиты и внешние интеграции
└── text/                   # Текстовые сообщения бота
```

## Функциональность

### Основные команды

- `/start` - Начать работу с ботом
- `/help` - Показать справку
- `/change_timezone` - Изменить часовой пояс
- `/upcoming_events` - Показать предстоящие события (отсортированные по времени события)
- `/upcoming_notifications` - Показать предстоящие уведомления (отсортированные по времени уведомления)

#### Разница между командами `/upcoming_events` и `/upcoming_notifications`

- **`/upcoming_events`** - показывает события, упорядоченные по времени самого события. Полезно для понимания хронологии ваших дел.
- **`/upcoming_notifications`** - показывает события, упорядоченные по времени уведомлений. Полезно для понимания в каком порядке к вам будут приходить напоминания.

Например, если у вас есть встреча завтра в 15:00 (с напоминанием в 14:40) и звонок сегодня в 18:00 (с напоминанием в 18:00), то:
- `/upcoming_events` покажет сначала звонок, затем встречу (по времени событий)
- `/upcoming_notifications` покажет сначала встречу, затем звонок (по времени уведомлений)

**Техническая деталь**: Обе команды используют универсальную функцию `get_events_by_user_sorted()` с разными параметрами сортировки.

### Создание событий

Бот поддерживает несколько способов создания событий:

#### 1. Текстовые сообщения
Отправьте боту сообщение в естественном стиле:
- "Напомни завтра в 15:00 о встрече с клиентом"
- "Через 2 часа нужно принять лекарство"
- "В понедельник утром поход к стоматологу"

#### 2. Голосовые сообщения
Запишите голосовое сообщение с описанием события - бот распознает речь и создаст напоминание.

#### 3. Типы событий

**Обычные события (moment)**
- Напоминание приходит точно в указанное время
- Подходит для простых задач

**События с подготовкой (prepar)**
- Напоминание приходит за 20 минут до события
- Подходит для встреч, походов к врачу, важных мероприятий

**Повторяющиеся события (repeat_moment/repeat_prepar)**
- Автоматически создаются новые уведомления после каждого срабатывания
- Поддерживают различные интервалы повторения

### Управление событиями

После создания события или при получении уведомления доступны кнопки:

- **+10 минут** - Отложить на 10 минут
- **+1 час** - Отложить на час
- **+1 день** - Отложить на день
- **Отложить на другое время** - Ввести произвольное время отложения
- **Выполнено** - Пометить как выполненное
- **Не сделано** - Пометить как невыполненное
- **Удалить** - Удалить событие

### Часовые пояса

Бот поддерживает работу с часовыми поясами:
- Автоматическое определение по геолокации
- Ручной ввод смещения относительно UTC
- Корректное отображение времени в пользовательском часовом поясе

## Модели данных

### User (Пользователь)
```sql
- id: UUID - уникальный идентификатор
- tg_id: str - Telegram ID пользователя
- tg_username: str - Telegram username
- tg_name: str - Имя пользователя
- timezone: float - Часовой пояс (смещение от UTC)
```

### Event (Событие)
```sql
- id: UUID - уникальный идентификатор
- type: str - тип события (moment, prepar, repeat_moment, repeat_prepar)
- name: str - описание события
- status: str - статус (pending, completed, not_completed, deleted)
- time: datetime - время события
- reschedule_timedelta: timedelta - интервал для переноса/повторения
- user_id: UUID - ID пользователя
```

### Notification (Уведомление)
```sql
- id: UUID - уникальный идентификатор
- event_id: UUID - ID события
- notify_ts: datetime - время уведомления
- sent_ts: datetime - время отправки
- status: str - статус уведомления (pending, sent, terminated)
- workflow_id: str - ID Temporal workflow
```

## Temporal Workflows

### NotificationWorkflow
Отвечает за отправку уведомлений:
1. Отправляет уведомление пользователю
2. Обновляет статус в базе данных
3. Создает следующее уведомление (для повторяющихся событий)

### ProcessMessageWorkflow
Обрабатывает сообщения пользователей:
1. Отправляет текст в Yandex GPT
2. Парсит JSON с данными события
3. Создает событие в базе данных
4. Запускает workflow для уведомлений

## Внешние интеграции

### Yandex Cloud
- **Yandex GPT** - обработка естественного языка
- **Yandex SpeechKit** - распознавание речи
- **IAM токены** - аутентификация в Yandex Cloud

### Telegram Bot API
- Получение сообщений и команд
- Отправка уведомлений
- Интерактивные кнопки (Inline Keyboard)

## Развертывание

### Требования
- Python 3.12+
- PostgreSQL
- Temporal Server
- Docker (для контейнеризации)

### Установка зависимостей
```bash
make venv
make install
```

### Локальный запуск
```bash
make db
make up
```

### Docker развертывание
```bash
make docker
```

### Переменные окружения
```env
TG_BOT_TOKEN=your_telegram_bot_token
POSTGRES_DB=data
POSTGRES_USER=pguser
POSTGRES_PASSWORD=pgpswd
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
YANDEX_CLOUD_PRIVATE_KEY_FILE=path/to/private/key
YANDEX_CLOUD_KEY_ID=your_key_id
YANDEX_CLOUD_SERVICE_ACCOUNT_ID=your_service_account
YANDEX_CLOUD_CATALOG_ID=your_catalog_id
```

## Разработка

### Структура команд make

```bash
make venv          # Создать виртуальное окружение
make install       # Установить зависимости
make db           # Запустить базу данных
make up           # Запустить приложение
make docker       # Запустить в Docker
make check        # Проверки кода
make format       # Форматирование кода
make lint         # Линтинг кода
make test         # Запустить тесты
make gen          # Генерация кода
```

### Рабочий процесс для AI агента

При работе с проектом AI агенту рекомендуется следовать следующему порядку:

1. **Запуск базы данных (обязательно перед тестами)**:
   ```bash
   make db
   ```

2. **Проверка качества кода (главная команда)**:
   ```bash
   make check
   ```
   Эта команда запускает все проверки: форматирование, линтинг, проверку типов и тесты.

3. **Отдельные команды для точечных проверок**:
   ```bash
   make format       # Форматирование кода (Black, isort)
   make lint         # Линтинг (Ruff, Flake8, MyPy, Pylint)
   make test         # Тесты (pytest с покрытием)
   ```

**Важно**: Команды `make format`, `make lint`, `make test` должны запускаться именно в таком порядке, если используются отдельно. Команда `make check` уже включает все эти проверки в правильном порядке.

### Генерация кода

В проекте есть автоматически генерируемые файлы, помеченные комментарием `# Code generated automatically.`:

**Автогенерируемые файлы:**
- `tests/factory_lib/*.py` - фабрики для тестовых данных
- `tools/gen/_list_of_gens.py` - список генераторов

**Пересоздание автогенерируемых файлов:**
```bash
make gen    # Запускает все генераторы кода
```

**Структура генераторов:**
- **Скрипты**: `tools/gen/` - Python-скрипты для генерации
- **Шаблоны**: `tools/gen/*/templates/` - Jinja2 шаблоны
- **Конфигурация**: `tools/gen/_main.py` - основной генератор

**Когда нужно запускать `make gen`:**
- После изменения моделей базы данных
- При добавлении новых генераторов
- Если автогенерируемые файлы повреждены или отсутствуют

⚠️ **Важно**: Никогда не редактируйте файлы с `# Code generated automatically.` вручную - они будут перезаписаны при следующем запуске `make gen`.

### Тестирование

Проект включает:
- Юнит-тесты с pytest
- Покрытие кода с pytest-cov (минимум 50%)
- Фабрики для тестовых данных (factory-boy)
- Тесты миграций базы данных
- Мок-тесты для Telegram API

**Требования к тестам:**
- База данных PostgreSQL должна быть запущена (`make db`)
- Покрытие кода не менее 50%
- Все тесты должны быть изолированы и не зависеть друг от друга

### Линтинг и форматирование

Используемые инструменты:
- **Black** - форматирование кода
- **Ruff** - быстрый линтер
- **MyPy** - проверка типов
- **Pylint** - дополнительные проверки (цель: 10.00/10)
- **isort** - сортировка импортов
- **Flake8** - проверка стиля кода

**Критерии качества:**
- Pylint: 10.00/10 (без ошибок)
- MyPy: все файлы проверены успешно
- Ruff/Flake8: без предупреждений
- Black: код отформатирован

## Мониторинг и логирование

### Логирование
- **Loguru** - основная библиотека для логирования
- **Loki** - централизованное хранение логов
- Структурированные логи с контекстом

### Мониторинг
- **Grafana** - визуализация метрик
- **Prometheus** - сбор метрик
- Мониторинг здоровья Temporal workflows

## Безопасность

- Секретные токены через pydantic.SecretStr
- Валидация пользовательского ввода
- Middleware для проверки пользователей
- Ограничение доступа к административным функциям

## Производительность

- Асинхронная архитектура (asyncio)
- Пулы соединений с базой данных
- Кэширование токенов Yandex Cloud
- Оптимизированные запросы к базе данных

## Обработка ошибок

- Graceful обработка ошибок Telegram API
- Retry механизмы для внешних сервисов
- Детальное логирование ошибок
- Уведомления об ошибках в отдельный чат

## Расширение функциональности

### Добавление новых типов событий
1. Обновить схемы в `bot/schemas/`
2. Добавить логику в `ProcessMessageWorkflow`
3. Обновить промт для GPT

### Добавление новых команд
1. Создать обработчик в `bot/handlers/`
2. Добавить роутер в `bot/handlers/__init__.py`
3. Обновить список команд в `bot/creator.py`

### Интеграция с новыми сервисами
1. Добавить утилиты в `bot/utils/`
2. Обновить конфигурацию в `bot/config/`
3. Добавить необходимые зависимости

## Лицензия

Проект распространяется под лицензией, указанной в файле License.md.

## Поддержка

Для получения поддержки или сообщения об ошибках используйте Issues в репозитории проекта.
